# Sign in with Apple - Go

![](https://img.shields.io/badge/golang-1.24-blue.svg?style=flat)

A library for integrate the Sign in with Apple feature in server-side.

> Ref: https://developer.apple.com/documentation/signinwithapplerestapi

## Installation

```text
go get github.com/AyakuraYuki/go-sign-in-with-apple

import "github.com/AyakuraYuki/go-sign-in-with-apple/apple"
```

## Usage

There are several examples based on particular use case which can be found
below:

- [Validating an app token](example/validate-app-token/main.go)
- [Validating a web token](example/validate-web-token/main.go)
- [Validating a refresh token](example/validate-refresh-token/main.go)
- [Revoking an access token](example/revoke-access-token/main.go)
- [Revoking a refresh token](example/revoke-refresh-token/main.go)
- [Transfers across teams](example/user-migration/main.go)

### Example

While it is recommended to look at the specific example files, here is a
basic use case:

```go
package main

import (
	"context"
	"fmt"

	"github.com/AyakuraYuki/go-sign-in-with-apple/apple"
)

func main() {
	authKey := apple.AuthKey{
		KeyID:      "AB12CD34EF",
		ClientID:   "com.yourapp.bundleid",
		TeamID:     "GH56IJ78KL",
		SigningKey: "-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----",
	}
	clientSecret, _ := apple.GenerateClientSecret(authKey)
	client, _ := apple.NewClient()
	rsp, _ := client.ValidateAppToken(
		context.Background(),
		authKey.ClientID,
		clientSecret,
		"the_authorization_code_to_validate")
	_, token, _ := client.VerifyTokenSignature(rsp.IDToken)
	userIdentifier, _ := apple.GetUniqueID(token)
	fmt.Println(userIdentifier)
}

```

Also, it's recommended to create and maintain `apple.Client` instance as a
singleton in production environment. When a client created, there is a ticker
for fetching and updating Apple's public key, running as a coroutine.

### Generating `client_secret`

Apple requires a JWT token along with your request to authenticate your
request. A token can be generated by calling `apple.GenerateClientSecret`
function included. Check [secret.go](apple/secret.go) to see exactly how
to obtain the parameters required by this function. Make sure your account
have permissions to view and create `Service IDs` and `Keys` required by
this function.

```go
package main

import (
	"fmt"

	"github.com/AyakuraYuki/go-sign-in-with-apple/apple"
)

func main() {
	authKey := apple.AuthKey{
		KeyID:      "AB12CD34EF",
		ClientID:   "com.yourapp.bundleid",
		TeamID:     "GH56IJ78KL",
		SigningKey: "-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----",
	}
	clientSecret, _ := apple.GenerateClientSecret(authKey)
	fmt.Println(clientSecret)
}

```

### Validating token and verifying the ID token signature

It is recommended to verify the `id_token` signature for every TokenResponse.
To validate and verify a token, create a new validation `Client` then call the
respective `Validate` function, then call the `VerifyTokenSignature` function
to verify the signature.

Again, it's recommended to create and maintain `apple.Client` instance as a
singleton in production environment. When a client created, there is a ticker
for fetching and updating Apple's public key, running as a coroutine.

```go
package main

import "github.com/AyakuraYuki/go-sign-in-with-apple/apple"

func main() {
	// ...

	// create a new Sign in with Apple client
	client, _ := apple.NewClient()
	// do the validation
	rsp, _ := client.ValidateAppToken(
		context.Background(),
		authKey.ClientID,
		clientSecret,
		"the_authorization_code_to_validate")
	// verify token signature
	_, token, _ := client.VerifyTokenSignature(rsp.IDToken)
}

```

### Obtaining data

#### Unique Subject ID

A subject ID is included in the `id_token` of the TokenResponse which when
decoded, has a subject that can uniquely identify the user. A helper function
is provided to obtain subject ID: `apple.GetUniqueID`.

#### Email

You have access to the following fields:

- email
- email_verified - whether the user has validated their email with Apple
- is_private_email - whether the email is a private delay email from Apple

A helper function is provided to obtain these fields: `apple.GetEmail`.

## User Migration

This library supports you to transfer users across teams, by providing the
following functions to do that:

- `ObtainMigrationAccessToken`
- `GenerateTransferSub`
- `ExchangeIdentifier`

A example shows how to do the whole progress, which is verified in real
business usage.

- [Transfers across teams (example)](example/user-migration/main.go)

For more details, please check the official instruction: [Transfers across teams](https://developer.apple.com/documentation/signinwithapple#Transfers-across-teams)

## License

Licensed under the MIT License.
